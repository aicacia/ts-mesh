import{nextIntInRange as e,fromArray as t}from"https://unpkg.com/browse/@aicacia/rand@0/browser/index.js";import{io as n}from"https://unpkg.com/socket.io-client@4/dist/socket.io.esm.min.js";var s={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function s(){}function o(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,s,i,c){if("function"!=typeof s)throw new TypeError("The listener must be a function");var r=new o(s,i||e,c),a=n?n+t:t;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],r]:e._events[a].push(r):(e._events[a]=r,e._eventsCount++),e}function c(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function r(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(n=!1)),r.prototype.eventNames=function(){var e,s,o=[];if(0===this._eventsCount)return o;for(s in e=this._events)t.call(e,s)&&o.push(n?s.slice(1):s);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},r.prototype.listeners=function(e){var t=n?n+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var o=0,i=s.length,c=new Array(i);o<i;o++)c[o]=s[o].fn;return c},r.prototype.listenerCount=function(e){var t=n?n+e:e,s=this._events[t];return s?s.fn?1:s.length:0},r.prototype.emit=function(e,t,s,o,i,c){var r=n?n+e:e;if(!this._events[r])return!1;var a,h,f=this._events[r],u=arguments.length;if(f.fn){switch(f.once&&this.removeListener(e,f.fn,void 0,!0),u){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,t),!0;case 3:return f.fn.call(f.context,t,s),!0;case 4:return f.fn.call(f.context,t,s,o),!0;case 5:return f.fn.call(f.context,t,s,o,i),!0;case 6:return f.fn.call(f.context,t,s,o,i,c),!0}for(h=1,a=new Array(u-1);h<u;h++)a[h-1]=arguments[h];f.fn.apply(f.context,a)}else{var p,l=f.length;for(h=0;h<l;h++)switch(f[h].once&&this.removeListener(e,f[h].fn,void 0,!0),u){case 1:f[h].fn.call(f[h].context);break;case 2:f[h].fn.call(f[h].context,t);break;case 3:f[h].fn.call(f[h].context,t,s);break;case 4:f[h].fn.call(f[h].context,t,s,o);break;default:if(!a)for(p=1,a=new Array(u-1);p<u;p++)a[p-1]=arguments[p];f[h].fn.apply(f[h].context,a)}}return!0},r.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},r.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},r.prototype.removeListener=function(e,t,s,o){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return c(this,i),this;var r=this._events[i];if(r.fn)r.fn!==t||o&&!r.once||s&&r.context!==s||c(this,i);else{for(var a=0,h=[],f=r.length;a<f;a++)(r[a].fn!==t||o&&!r[a].once||s&&r[a].context!==s)&&h.push(r[a]);h.length?this._events[i]=1===h.length?h[0]:h:c(this,i)}return this},r.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&c(this,t)):(this._events=new s,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=n,r.EventEmitter=r,e.exports=r}(s);class o extends s.exports.EventEmitter{peer;maxConnections=6;syncMS=6e4;messageLastSeenDeleteMS=18e4;messageId=0;messages=new Map;constructor(e,t={}){super(),this.peer=e,this.peer.on("data",this.onData),this.peer.on("join",this.onDiscover),this.peer.on("announce",this.onDiscover),this.peer.once("connect",this.onSync),"number"==typeof t.maxConnections&&t.maxConnections>0&&(this.maxConnections=t.maxConnections),"number"==typeof t.syncMS&&t.syncMS>5e3&&(this.syncMS=t.syncMS),"number"==typeof t.messageLastSeenDeleteMS&&t.messageLastSeenDeleteMS>0&&(this.messageLastSeenDeleteMS=t.messageLastSeenDeleteMS),this.sync()}getPeer(){return this.peer}broadcast(e){const t=this.peer.getId(),n=this.messageId++,s=`${t}-${n}`;return this.messages.set(s,Date.now()),this.peer.broadcast(JSON.stringify({id:n,from:t,payload:e})),this}needsConnection(){return this.peer.getConnections().size<this.maxConnections}onData=(e,t)=>{if("string"==typeof e||Buffer.isBuffer(e)){const t=JSON.parse(e.toString()),n=`${t.from}-${t.id}`;this.messages.has(n)||(this.messages.set(n,Date.now()),this.peer.broadcast(e),this.emit("data",t.payload,t.from))}};onDiscover=e=>{this.peer.getConnections().has(e)||(this.needsConnection()?this.peer.connectToInBackground(e):this.peer.connectTo(e).then((()=>{const t=Array.from(this.peer.getConnections().keys());t.length>1&&this.peer.disconnectFrom(i(t,e))})))};onSync=()=>{this.needsConnection()&&this.peer.announce(),this.cleanOldMessages(),this.sync()};sync(){setTimeout(this.onSync,e(.5*this.syncMS,this.syncMS))}cleanOldMessages(){if(this.messages.size){const e=Date.now();for(const[t,n]of this.messages.entries())e-n>this.messageLastSeenDeleteMS&&this.messages.delete(t)}}}function i(e,n){const s=t(e).unwrap();return s===n?i(e,n):s}class c extends s.exports.EventEmitter{socket;connections=new Map;SimplePeer;constructor(e){super(),this.SimplePeer=e.SimplePeer,this.socket=n(`${e.origin||"wss://mesh.aicacia.com"}/${e.namespace||""}`),this.socket.on("signal",this.onSignal),this.socket.on("connect",this.onConnect),this.socket.on("disconnect",this.onDisonnect),this.socket.on("join",this.onJoin),this.socket.on("announce",this.onAnnounce),this.socket.on("leave",this.onLeave)}getId(){return this.socket.id}isConnected(){return this.socket.connected}connected(){return r(this.socket)}getConnections(){return this.connections}onSignal=(e,t)=>{let n=this.connections.get(t);"offer"===e.type&&n?.initiator&&(this.disconnectFrom(t,!1),n=void 0),n||(n=this.createConnection(t,!1)),n.destroyed||n.signal(e)};onConnect=()=>{this.emit("connect",this.socket.id)};onDisonnect=()=>{this.emit("disconnect");for(const[e,t]of this.connections.entries())this.emit("disconnection",t,e),t.destroy();this.connections.clear()};onJoin=e=>{e!==this.socket.id&&this.emit("join",e)};onAnnounce=e=>{e!==this.socket.id&&this.emit("announce",e)};onLeave=(e,t)=>{this.disconnectFrom(e)};send(e,t){const n=this.connections.get(e);return n?.connected&&n.send(t),this}broadcast(e){for(const t of this.connections.values())t.connected&&t.send(e);return this}announce(){return this.socket.emit("announce"),this}get(e){return this.connections.get(e)}connectToInBackground(e){return this.getOrCreateConnection(e,!0),this}connectTo(e){const t=this.getOrCreateConnection(e,!0);return new Promise(((e,n)=>{if(t.connected)e(t);else{const s=()=>{c(),e(t)},o=()=>{c(),n()},i=e=>{c(),n(e)},c=()=>{t.off("connect",s),t.off("disconnect",o),t.off("error",i)};t.once("connect",s),t.once("disconnect",o),t.once("error",i)}}))}disconnectFrom(e,t=!0){const n=this.connections.get(e);return n&&(t&&this.emit("disconnection",n,e),this.connections.delete(e),n.destroy()),this}getOrCreateConnection(e,t){const n=this.connections.get(e);return n||this.createConnection(e,t)}createConnection(e,t){const n=new this.SimplePeer({initiator:t,trickle:!1});return n.on("signal",(t=>{this.socket.emit("signal",e,t)})),n.on("data",(t=>{this.emit("data",t,e)})),n.on("error",(t=>{this.disconnectFrom(e),this.emit("error",t)})),n.on("connect",(()=>{this.emit("connection",n,e)})),n.on("disconnect",(()=>{this.disconnectFrom(e)})),this.connections.set(e,n),n}}function r(e){return new Promise(((t,n)=>{if(e.connected)t(e);else{const s=()=>{c(),t(e)},o=()=>{c(),n()},i=e=>{c(),n(e)},c=()=>{e.off("connect",s),e.off("disconnect",o),e.off("error",i)};e.once("connect",s),e.once("disconnect",o),e.once("error",i)}}))}export{o as Mesh,c as Peer,r as waitForSocket};
//# sourceMappingURL=index.js.map
